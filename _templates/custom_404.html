<html>
<head>
   <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
   <meta http-equiv="Pragma" content="no-cache">
   <meta http-equiv="Expires" content="-1">
   <meta charset="utf-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>MusicBrainz Picard Documentation</title>
</head>
<body>
   <div id='redirection_error'></div>
   <script>
      var default_language = 'en';
      var target_language = '{{ language }}';
      var target_version = 'latest';
      var stable_version = 'stable';
      var src_host = window.location.hostname;
      var src_protocol = window.location.protocol;
      var src_path = window.location.pathname;
      var src_path_parts = src_path.split('/');
      var target_path = '';
      var target_url = '';
      var has_language = false;
      var has_version = false;
      var language_changed = true;
      var version_changed = true;
      var well_formed = true;

      var debug = false;

      const re_language = /^[a-z][a-z](_[A-Z][A-Z])?$/;
      const re_version = /^[vV]?([0-9]+\.[0-9]+).*$/;

      const not_found = 'not_found.html';

      function is_language(test_language) {
         // Returning true will drop this item from the path
         var test_value = test_language.replace("-", "_");
         if (debug) { window.alert("Testing language: " + test_language); }
         if (test_value.search(re_language) < 0) {
            if (debug) { window.alert("Failed regular expression check."); }
            return false;
         }
         target_language = test_value;
         has_language = true;
         language_changed = false;
         return true;
      }

      function is_version(test_version) {
         // Returning true will drop this item from the path
         if (debug) { window.alert("Testing version: " + test_version); }

         // Check for ReadTheDocs style version number
         if (test_version.toLowerCase() == 'latest') {
            has_version = true;
            target_version = 'latest';
            if (debug) { window.alert("Passed. Target version set to: " + target_version); }
            return true;
         }
         if (test_version.toLowerCase() == 'stable') {
            has_version = true;
            target_version = 'stable';
            if (debug) { window.alert("Passed. Target version set to: " + target_version); }
            return true;
         }

         var arr = re_version.exec(test_version);
         if (!arr) {
            if (debug) { window.alert("Failed version regular expression check."); }
            return false;
         }
         has_version = true;
         var temp = arr[1];
         target_version = 'v' + temp;
         if (test_version == target_version) { version_changed = false; }
         if (debug) { window.alert("Passed. Target version set to: " + target_version); }
         return true;
      }

      var counter = 1;
      // Check if already redirected to a not found page
      if (src_path_parts[src_path_parts.length - 1] == not_found) {
         if (debug) { window.alert("Unable to find the not_found.html file."); }
         if (src_path_parts[src_path_parts.length - 2] == default_language) {
            document.getElementById('redirection_error').innerHTML = "<h1>Redirection Error</h1>\n<p>We're sorry but there was a problem redirecting to your requested page.</p>";
         }
         else {
            target_url = src_protocol + '//' + src_host + '/' + default_language + '/' + stable_version + '/' + not_found;
            if (debug) { window.alert("Redirecting to:\n" + target_url); }
            window.location.replace(target_url);
         }
      }
      else {
         // Check for version number
         if (is_version(src_path_parts[counter])) {
            counter += 1;
         }

         // Check for language identifier
         if (is_language(src_path_parts[counter])) {
            counter += 1;
         }

         // Recheck for version number to accommodate different order in url
         if (is_version(src_path_parts[counter])) {
            counter += 1;
         }

         // Recheck for language identifier to accommodate different order in url
         if (is_language(src_path_parts[counter])) {
            counter += 1;
         }

         var anchor_test = document.URL.split('#');
         if (debug) { window.alert('Performing anchor test.\n\nLength: ' + anchor_test.length + "\nLast Part: " + anchor_test[anchor_test.length - 1]); }
         if ((anchor_test.length > 1) && (anchor_test[anchor_test.length - 1] == "redirected")) {
            target_url = src_protocol + '//' + src_host + '/' + target_language + '/' + target_version + '/' + not_found;
            if (debug) { window.alert('Page has already been redirected.\n\nOld URL: ' + window.location + "\nNew URL: " + target_url); }
         }
         else {
            // Patch to redirect to new location of scripting documentation
            if (src_path_parts[counter] == 'scripting.html') {
               target_path += '/extending';
               if (debug) { window.alert("Patching target url for updated location of scripting.html file."); }
               well_formed = false;
            }
            else if (src_path_parts[counter] == 'technical') {
               target_path += '/appendices';
               counter += 1;
               well_formed = false;
            }

            // Combine remaining portions of the submitted path
            while (counter < src_path_parts.length) {
               target_path += '/' + src_path_parts[counter];
               counter += 1;
            }

            // Build the redirection target url
            target_url = src_protocol + '//' + src_host + '/' + target_language + '/' + target_version;
            if ((language_changed) || (version_changed)) { well_formed = false; }
            if ((well_formed) || (target_url + target_path == window.location)) {
               if (debug) {
                  if (well_formed) {
                     window.alert("well_formed is true.");
                  }
                  if (target_url + target_path == window.location) {
                     window.alert("Target path same as the source path.");
                  }
               }
               target_url += '/' + not_found;
            }
            else {
               target_url += target_path + "#redirected";
            }
            if (debug) { window.alert('Old URL: ' + window.location + "\nNew URL: " + target_url); }
         }

         // Redirect to the new target
         window.location.href = target_url;
      }
   </script>
</body>
</html>
